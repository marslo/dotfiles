#!/usr/bin/env bash
# shellcheck source=/dev/null disable=SC2034
# =============================================================================
#   FileName : .marslorc
#     Author : marslo.jiao@gmail.com
#    Created : 2012
# LastChange : 2026-02-03 16:36:32
# =============================================================================

# execute configuration only in the interactive shell
[[ "${-}" != *i* ]] && return

export iRCHOME="$HOME/.marslo"
# credit: https://github.com/ppo/bash-colors/blob/master/bash-colors.sh (v0.3.0)
test -f "${iRCHOME}/bin/bash-color.sh" && source "${iRCHOME}/bin/bash-color.sh"

function isWSL()     { uname -r | command grep --color=never -q -i 'microsoft'; }
function isCygwin()  { test "$(uname -s)" =~ 'CYGWIN_NT'; }
function isGitBash() { test "$(uname -s)" =~ 'MINGW64_NT'; }
function isOSX()     { test 'Darwin' = "$(uname -s)"; }
function isLinux()   { ! isWSL && test 'Linux' = "$(uname -s)"; }
function isDebian()  { test -f /etc/os-release && grep -iqE 'ID_LIKE="?debian' /etc/os-release; }
function isFedora()  { test -f /etc/os-release && test 'fedora' = "$(awk -F '='    '/^ID=/ { print $2 }' /etc/os-release)"; }
function isUbuntu()  { test -f /etc/os-release && test 'ubuntu' = "$(awk -F '='    '/^ID=/ { print $2 }' /etc/os-release)"; }
function isRHEL()    { test -f /etc/os-release && test 'rhel'   = "$(awk -F '[="]' '/^ID=/ { print $3 }' /etc/os-release)"; }
function isCentOS()  { test -f /etc/os-release && test 'centos' = "$(awk -F '[="]' '/^ID=/ { print $3 }' /etc/os-release)"; }
# for public server (use common account)
function bello()     { source ~/.marslo/.marslorc; set -o vi;  }
function bye()       { source "${iRCHOME}"/.bye; set -o emacs; }

# rebuild brew cache
if isOSX; then
  test -d "$(brew --cache)" || brew upgrade >/dev/null 2>&1

  test -f /opt/homebrew/bin/brew && HOMEBREW_PREFIX="/opt/homebrew"
  test -f /usr/local/bin/brew    && HOMEBREW_PREFIX="/usr/local"
fi

# /--------------------------------------------------------------
#      _       __            _ _     _              _
#     | |     / _|          | | |   | |            | |
#   __| | ___| |_ __ _ _   _| | |_  | |_ ___   ___ | |___
#  / _` |/ _ \  _/ _` | | | | | __| | __/ _ \ / _ \| / __|
# | (_| |  __/ || (_| | |_| | | |_  | || (_) | (_) | \__ \
#  \__,_|\___|_| \__,_|\__,_|_|\__|  \__\___/ \___/|_|___/
#
# --------------------------------------------------------------/
LS="$(type -P ls)"
GREP="$(type -P grep)"
COLUMN="$(type -P column)"
CAT="$(type -P cat)"

if isOSX && [[ 0 = $(type -P brew >/dev/null; echo $?) ]]; then
  test -x "${HOMEBREW_PREFIX}/bin/bat"                   && CAT="${HOMEBREW_PREFIX}/bin/bat"
  test -x "${HOMEBREW_PREFIX}/bin/gls"                   && LS="${HOMEBREW_PREFIX}/bin/gls"
  test -x "${HOMEBREW_PREFIX}/bin/ggrep"                 && GREP="${HOMEBREW_PREFIX}/bin/ggrep"
  test -x "${HOMEBREW_PREFIX}/opt/util-linux/bin/column" && COLUMN="${HOMEBREW_PREFIX}/opt/util-linux/bin/column"
else
  test -x '/usr/bin/ls'   && LS='/usr/bin/ls'      || LS='/bin/ls'
  test -x '/usr/bin/grep' && GREP='/usr/bin/grep'  || GREP='/bin/grep'
fi

COPY=''
isWSL && COPY='/mnt/c/Windows/System32/clip.exe'
isOSX && COPY="$(type -P pbcopy)"

# /--------------------------------------------------------------
#  ___  ___  _   _ _ __ ___ ___
# / __|/ _ \| | | | '__/ __/ _ \
# \__ \ (_) | |_| | | | (_|  __/
# |___/\___/ \__,_|_|  \___\___|
#
# --------------------------------------------------------------/
GROOVY_HOME='/opt/groovy/current'
FZF_HOME="${iRCHOME}"/utils/fzf

if isOSX; then
  GROOVY_HOME="${HOMEBREW_PREFIX}/opt/groovy"
  FZF_HOME="${HOMEBREW_PREFIX}/opt/fzf"
  test -f "${iRCHOME}"/.imac   && source "${iRCHOME}"/.imac
elif isLinux; then                                            # for Ubuntu/RHEL/CentOS
  isDebian && export DEBIAN_FRONTEND=noninteractive
  test -f "${iRCHOME}"/.ilinux && source <( /bin/cat "${iRCHOME}"/.ilinux )
fi

test -f "${iRCHOME}"/.env                  && source "${iRCHOME}"/.env
test -f "${iRCHOME}"/.token                && source "${iRCHOME}"/.token
test -f "${iRCHOME}"/.alias                && source "${iRCHOME}"/.alias                # alias
test -f "${iRCHOME}"/.completion           && source "${iRCHOME}"/.completion           # completion

test -f "$HOME"/.cargo/env                 && source "$HOME"/.cargo/env
test -s "$HOME"/.sdkman/bin/sdkman-init.sh && source "$HOME"/.sdkman/bin/sdkman-init.sh
test -f "$HOME"/.rbenv/bin/rbenv           && eval "$("$HOME"/.rbenv/bin/rbenv init - bash)"
test -f "$HOME"/.docker/init-bash.sh       && source "$HOME"/.docker/init-bash.sh       # docker desktop
type -P pyenv >/dev/null                   && eval "$(pyenv init -)"

# /--------------------------------------------------------------
#                   __ _
#                  / _(_)
#   ___ ___  _ __ | |_ _  __ _
#  / __/ _ \| '_ \|  _| |/ _` |
# | (_| (_) | | | | | | | (_| |
#  \___\___/|_| |_|_| |_|\__, |
#                         __/ |
#                        |___/
#
# --------------------------------------------------------------/
# check via `$ shopt -p`
shopt -s cdspell
shopt -s dirspell
shopt -s cmdhist
shopt -s histappend
shopt -s globstar
shopt -s autocd
# shopt -s extdebug -- fcf
# shopt -s nullglob -- completion source

### disable ctrl+s lock putty : # stty -echo; stty stop undef; stty start undef
# - [reference](https://stackoverflow.com/a/25391867/2940319)
#   - tput : No value for $TERM and no -T specified
#   - stty : 'standard input': Inappropriate ioctl for device
if [[ $- == *i* ]]; then
  stty ixany
  stty ixoff -ixon
  test -f ~/.LESS_TERMCAP && source ~/.LESS_TERMCAP
fi

# /--------------------------------------------------------------
#  _                                     _
# | |                                   | |
# | |_ ___ _ __ _ __ ___ ______ ___ ___ | | ___  _ __
# | __/ _ \ '__| '_ ` _ \______/ __/ _ \| |/ _ \| '__|
# | ||  __/ |  | | | | | |    | (_| (_) | | (_) | |
#  \__\___|_|  |_| |_| |_|     \___\___/|_|\___/|_|
#
#
# --------------------------------------------------------------/
export TERM='xterm-color'
# screen: /usr/share/terminfo/73/screen.xterm-256color
# centos/rhel
test -e /usr/share/terminfo/x/xterm-256color  && export TERM='xterm-256color'
# ubuntu
test -e /lib/terminfo/x/xterm-256color        && export TERM='xterm-256color'
# cygwin/osx
test -e /usr/share/terminfo/78/xterm-256color && export TERM='xterm-256color'

# /--------------------------------------------------------------
#                   __
#                  / _|
#  _ __ ___  _   _| |_ _   _ _ __   ___
# | '_ ` _ \| | | |  _| | | | '_ \ / __|
# | | | | | | |_| | | | |_| | | | | (__
# |_| |_| |_|\__, |_|  \__,_|_| |_|\___|
#             __/ |
#            |___/
# --------------------------------------------------------------/
# rewrite help and history
test -f "${iRCHOME}/bin/help"    && source "${iRCHOME}/bin/help"
test -f "${iRCHOME}/bin/history" && source "${iRCHOME}/bin/history"

for script in "${iRCHOME}"/bin/{ifunc,ffunc,ig,irt,im,icolor}.sh; do
  test -f "${script}" && source "${script}";
done
isOSX && test -f "${iRCHOME}"/bin/ii.sh && source "${iRCHOME}"/bin/ii.sh

# disable system info shows in vscode/cursor/docker-desktop terminal and nvim/vim terminal
declare programs=('cursor' 'vscode' 'docker_desktop')
# shellcheck disable=SC2155
declare programsRE="^($(IFS='|'; printf '%s' "${programs[*]}"))$"
if ! [[ -n "${NVIM:-}" || -n "${VIMRUNTIME:-}" || "${TERM_PROGRAM:-}" =~ ${programsRE} ]]; then
  ! isLinux && test -f "${iRCHOME}"/bin/screenfetch-dev && bash "${iRCHOME}"/bin/screenfetch-dev
  test -f "${iRCHOME}"/bin/now        && bash   "${iRCHOME}"/bin/now
  test -f "${iRCHOME}"/.tmux-session  && source "${iRCHOME}"/.tmux-session
  isOSX     && echo ''
fi

# type -P starship >/dev/null 2>&1 && eval "$(starship init bash)"

# /--------------------------------------------------------------
#   __      __         _             _
#  / _|    / _|       | |           (_)
# | |_ ___| |_   _ __ | |_   _  __ _ _ _ __  ___
# |  _|_  /  _| | '_ \| | | | |/ _` | | '_ \/ __|
# | |  / /| |   | |_) | | |_| | (_| | | | | \__ \
# |_| /___|_|   | .__/|_|\__,_|\__, |_|_| |_|___/
#               | |             __/ |
#               |_|            |___/
# --------------------------------------------------------------/
if test -f "${iRCHOME}"/bin/fzf-git.sh; then source "${iRCHOME}"/bin/fzf-git.sh; fi

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:foldmethod=marker:foldmarker=#\ --------------------------------------------------------------/,#\ /--------------------------------------------------------------
