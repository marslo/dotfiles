#!/usr/bin/env bash
# shellcheck disable=SC2155
#=============================================================================
#     FileName : gh-pr-create
#       Author : marslo
#      Created : 2026-01-23 11:52:14
#   LastChange : 2026-01-23 12:19:39
#=============================================================================

set -euo pipefail

function pr-create() {
  local current="$(git branch --show-current)"
  test -z "${current}" && {
    echo "Error: Not in a git repository or detached HEAD."
    return 1
  }

  local gpreview="git show --color=always origin/{-1}"
  local main="$(gh repo view --json defaultBranchRef -q .defaultBranchRef.name)"
  local base=$({
                 echo "${main}";
                 git for-each-ref refs/remotes/origin --sort=-committerdate --format="%(refname:short)" | sed 's#^origin/##' ;
               } |
               awk '!seen[$0]++' |
               grep -v --color=never -E "^(${current}|HEAD)$" |
               fzf +m --prompt=' ' -0 \
                   --height 50% --min-height 10+ \
                   --style full --no-input-border \
                   --preview "${gpreview} -s" \
                   --preview-window=right,55%,nofollow --preview-label-pos='bottom' \
                   --bind "ctrl-o:execute(${gpreview})+change-preview(${gpreview} -s)+change-prompt( )" \
                   --bind 'ctrl-/:change-preview-window:up,60%|hidden|right,55%' \
                   --bind 'ctrl-y:execute-silent(git log origin/{-1} -1 --pretty=format:"%H" | pbcopy)'
              )
  test -z "${base:-}" && {
    echo "Error: No base branch selected."
    return 1
  }
  echo "Drafting PR: ${current} -> ${base}"

  local title=$(git log -1 --pretty=%s)
  # TODO: using AI to generate better body
  local body=$(git log -1 --pretty=%B)
  test -z "${body}" && body="Auto-generated PR from commit: ${title}"

  local cmd=( --base "${base}"
              --head "${current}"
              --title "${title}"
              --body "${body}"
            )
  gh pr create "${cmd[@]}"
}

pr-create "$@"

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:
