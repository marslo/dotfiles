#!/usr/bin/env bash
# shellcheck source=/dev/null

shopt -s extglob

# shellcheck disable=SC2155
declare -r HERE="$( dirname "${BASH_SOURCE[0]:-$0}" )"
# shellcheck disable=SC2155
declare -r ME="$(basename "${BASH_SOURCE[0]:-$0}" | tr '-' ' ')"
# @credit: https://github.com/ppo/bash-colors
# @usage:  or copy & paste the `c()` function from:
#          https://github.com/ppo/bash-colors/blob/master/bash-colors.sh#L3
# shellcheck disable=SC2015
test -f "${HERE}/bash-colors.sh" && source "${HERE}/bash-colors.sh" || { c() { :; }; }

function die() { echo -e "$(c R)ERROR$(c) : $*" >&2; exit 2; }
function exitOnError() { if [ $? -ne 0 ]; then echo -e "$(c R)ERROR$(c) : $*" >&2; exit 1; fi; }
function showHelp() { echo -e "${USAGE}"; exit 0; }
function needsArg() { [[ -z "$OPTARG" ]] && die "no arg for --$OPT option"; }
function isRepo() { git rev-parse --git-dir >/dev/null 2>&1 || exitOnError 'not a git repo !'; }
function getRevision() { sha=$(git rev-parse -q --verify "$1^{commit}"); echo "${sha}"; }
function trim() { IFS='' read -r str; echo "${str}" | sed -e 's/^[[:blank:]]*//;s/[[:blank:]]*$//'; }

function showParams() {
  [[ 6 -ne $# ]] && die "wrong parameters in showParams function"
  local author=$1
  local authorEmail=$2
  local authorDate=$3
  local committer=$4
  local commitEmail=$5
  local commitDate=$6

  echo -e """
  .. details ..

         $(c M)author$(c) : '${author}'
    $(c M)authorEmail$(c) : '${authorEmail}'
     $(c M)authorDate$(c) : '${authorDate}'
      $(c M)committer$(c) : '${committer}'
    $(c M)commitEmail$(c) : '${commitEmail}'
     $(c M)commitDate$(c) : '${commitDate}'
         $(c M)params$(c) : $(c G)
                   git <rr|ca> -a '${author}' -e '${authorEmail}' -d '${authorDate}' -c '${committer}' -E '${commitEmail}' -D '${commitDate}'
                   git <rr|ca> --author=\"${author}\" --authorEmail=\"${authorEmail}\" --authorDate=\"${authorDate}\" --committer=\"${committer}\" --commitEmail=\"${commitEmail}\" --commitDate=\"${commitDate}\"$(c)
    $(c M)environment$(c) : $(c C)
                   export GIT_AUTHOR_NAME='${author}'
                   export GIT_AUTHOR_EMAIL='${authorEmail}'
                   export GIT_AUTHOR_DATE='${authorDate}'
                   export GIT_COMMITTER_NAME='${committer}'
                   export GIT_COMMITTER_EMAIL='${commitEmail}'
                   export GIT_COMMITTER_DATE='${commitDate}'$(c)

  .. or you can manual export again ..

  $(c G)  \$$(c) $(c C)export GIT_AUTHOR_NAME='${author}'; export GIT_AUTHOR_EMAIL='${authorEmail}'; export GIT_AUTHOR_DATE='${authorDate}'; export GIT_COMMITTER_NAME='${committer}'; export GIT_COMMITTER_EMAIL='${commitEmail}'; export GIT_COMMITTER_DATE='${commitDate}'$(c)
    or
  $(c G)  \$$(c) $(c C)source ${tmpfile}$(c)
  """
}

function getInfo() {
  [[ 1 -ne $# ]] && die "must provide the revision number or refspec name for function getInfo"
  local revision=$1
  local command="git show -s ${revision} --pretty=tformat:'%an | %ae | %ad | %cn | %ce | %cd'"
  echo -n "$(eval "${command}" || exitOnError 'failed to get revision information')"
}

function doSetEnv() {
  [[ 6 -ne $# ]] && die "wrong parameters in showParams function"

  local author=$1
  local authorEmail=$2
  local authorDate=$3
  local committer=$4
  local commitEmail=$5
  local commitDate=$6

  cat > "${tmpfile}" << EOF
    GIT_AUTHOR_NAME="${author}"
    GIT_AUTHOR_EMAIL="${authorEmail}"
    GIT_AUTHOR_DATE="${authorDate}"
    GIT_COMMITTER_NAME="${committer}"
    GIT_COMMITTER_EMAIL="${commitEmail}"
    GIT_COMMITTER_DATE="${commitDate}"
EOF

  # shellcheck disable=SC1090
  source "${tmpfile}"
  "${silent}" || echo -e """  .. environment variable has been added to ..\n $(c G)${tmpfile}$(c)  """
}

function doRM() {
  if [[ -z "${filepath}" ]]; then
    tempath=$(dirname "${tmpfile}")
    # shellcheck disable=SC2045
    for _i in $(ls -A --color=none "${tempath}"); do rm -v "${tempath}"/"${_i}"; done
  else
   rm -v "${tmpfile}"
  fi
  exit 0
}

function doUnSetEnv() {
  GIT_COMMIT_ENV="GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL GIT_AUTHOR_DATE GIT_COMMITTER_NAME GIT_COMMITTER_EMAIL GIT_COMMITTER_DATE";
  for envvar in ${GIT_COMMIT_ENV}; do unset "${envvar}"; done;
  echo -e """
    .. unset successfully ..

      $(echo "${GIT_COMMIT_ENV}" | trim | tr ' ' ',') has been removed.

    .. or you can manually unset environment variable again ..

      $(c C)\$ unset GIT_AUTHOR_NAME; unset GIT_AUTHOR_EMAIL; unset GIT_AUTHOR_DATE; unset GIT_COMMITTER_NAME; unset GIT_COMMITTER_EMAIL; unset GIT_COMMITTER_DATE$(c)
  """;
  exit 0
}

declare help=false
declare verbose=false
declare unSetEnv=false
declare remove=false
declare silent=false
declare sha=''
declare filepath=''
# shellcheck disable=SC2155
declare -r USAGE="""
  $(c Cs)${ME}$(c) - to $(c Cis)set$(c) git revision author/authorEmail/authorDates/committer/commitEmail/commitDate to file

SYNOPSIS
  $(c sY)\$ ${ME} $(c 0G)[OPTIONS]$(c)

OPTIONS
  $(c G)-u$(c), $(c 0G)--unset$(c)                unset all git commit environment variables
  $(c G)-r$(c), $(c 0G)--revision$(c 0Mi)=SHA1$(c)        the revision number or refspec name to get the revision information.
                             i.e.: $(c 0Mi)\`HEAD\`$(c), $(c 0Mi)\`HEAD~1\`$(c), $(c 0Mi)\`master\`$(c), $(c 0Mi)\`v1.0.0\`$(c), etc
  $(c G)-f$(c), $(c 0G)--file$(c 0Mi)=path/to/file$(c)    the file to save the environment variable information
  $(c G)-d$(c), $(c 0G)--rm$(c), $(c 0G)--delete$(c)         remove the environment variable file created by ${ME} command
  $(c G)-v$(c), $(c 0G)--verbose$(c), $(c 0G)--debug$(c)     show the revision information after setting environment variable
  $(c G)-s$(c), $(c 0G)--silent$(c)               silent mode
  $(c G)-h$(c), $(c 0G)--help$(c)                 show this help message and exit

EXAMPLE
  $(c Wdi)# get verbose$(c)
  $(c Y)\$ ${ME} $(c 0Gi)-v$(c) | $(c Y)\$ ${ME} $(c 0Gi)--verbose$(c) | $(c Y)\$ ${ME} $(c 0Gi)--debug$(c)

  $(c Wdi)# to set revision information only$(c)
  $(c Y)\$ ${ME} $(c 0Gi)--revision$(c 0Mi)=<revision>$(c) | $(c Y)\$ ${ME} $(c 0Gi)-r $(c 0Mi)<revision>$(c)

  $(c Wdi)# to set revision information and setup the commit/push environment$(c)
  $(c Y)\$ ${ME} $(c 0Gi)--set --revision$(c 0Mi)=<revision>$(c) | $(c Y)\$ ${ME} $(c 0Gi)-s -r $(c 0Mi)<revision>$(c)

  $(c Wdi)# to remove all git commit environment variables$(c)
  $(c Y)\$ ${ME} $(c 0Gi)-u$(c) | $(c Y)${ME} $(c 0Gi)--unset$(c)

TIP
  the long parameters MUST use $(c Mi)'='$(c) to identify opt and args
"""

# for non '-' params
if [[ 1 -eq $# ]] && [[ '-' != "${1::1}" ]] && [[ "$1" =~ '=' ]]; then
  sha="$1"
else
  # credit belongs to https://stackoverflow.com/a/28466267/519360
  # shellcheck disable=SC2295
  while getopts :huvdsr:f:-: OPT; do
    if [ "$OPT" = "-" ]; then
      OPT="${OPTARG%%=*}"
      OPTARG="${OPTARG#$OPT}"
      OPTARG="${OPTARG#=}"
    fi
    case "$OPT" in
      h | help             ) help=true                     ;;
      v | verbose | debug  ) verbose=true                  ;;
      u | unset            ) unSetEnv=true                 ;;
      d | rm | delete      ) remove=true                   ;;
      s | silent           ) silent=true                   ;;
      r | revision         ) needsArg; sha="${OPTARG}"     ;;
      f | file             ) filepath="${OPTARG}"          ;;
      ??*                  ) die "Illegal option --${OPT}" ;;
      ?                    ) die "Illegal option --${OPT}" ;;
    esac
  done
  [[ 1 -eq $OPTIND ]] && showHelp
  shift $((OPTIND-1))
fi

tmp="$HOME/.marslo/.tmp"
path="${PWD}"
timestamp="$(date '+%Y%m%d')"
if [[ -z "${filepath}" ]]; then
  tmpfile="${tmp}"/$(echo "${path}" | tr ' ' '_' | tr '/' '.')-"${timestamp}"
else
  tmpfile="${filepath}"
fi
# shellcheck disable=SC2086
[[ -d "$(dirname ${tmpfile})" ]] || mkdir -p "$(dirname ${tmpfile})"

"${help}"     && showHelp
"${unSetEnv}" && doUnSetEnv
"${remove}"   && doRM

isRepo
revision=$(getRevision "${sha}")
[[ -z "${revision}" ]] && die "ref '${sha}' cannot be found in current repo."
# shortRevision="${revision:0:10}"

values=$(getInfo "${revision}")
author=$(echo "${values}"       |  awk -F'|' '{print $1}' | trim)
authorEmail=$(echo "${values}"  |  awk -F'|' '{print $2}' | trim)
authorDate=$(echo "${values}"   |  awk -F'|' '{print $3}' | trim)
committer=$(echo "${values}"    |  awk -F'|' '{print $4}' | trim)
commitEmail=$(echo "${values}"  |  awk -F'|' '{print $5}' | trim)
commitDate=$(echo "${values}"   |  awk -F'|' '{print $6}' | trim)

doSetEnv "${author}" "${authorEmail}" "${authorDate}" "${committer}" "${commitEmail}" "${commitDate}"
# shellcheck disable=SC2015
"${verbose}" && showParams "${author}" "${authorEmail}" "${authorDate}" "${committer}" "${commitEmail}" "${commitDate}" || true

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:
