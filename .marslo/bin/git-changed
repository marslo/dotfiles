#!/usr/bin/env bash
# shellcheck source=/dev/null
#=============================================================================
#     FileName : git-changed
#       Author : marslo
#      Created : 2025-08-22 15:24:56
#   LastChange : 2026-02-12 23:55:32
#=============================================================================

set -euo pipefail

# shellcheck disable=SC2155
declare -r HERE="$( dirname "${BASH_SOURCE[0]:-$0}" )"
# @credit: https://github.com/ppo/bash-colors
# @usage:  or copy & paste the `c()` function from:
#          https://github.com/ppo/bash-colors/blob/master/bash-colors.sh#L3
# shellcheck disable=SC2015
test -f "${HERE}/bash-colors.sh" && source "${HERE}/bash-colors.sh" || { c() { :; }; }

# section toggles (default all if none specified)
declare showStaged=0 showUnstaged=0 showUntracked=0 showIgnored=0 anySection=0
# title mode: 0=auto (only when has output), 1=all (force), 2=none (suppress)
declare showTitle=0
declare -a pathspec=()

# shellcheck disable=SC2125,SC2155
declare USAGE="""
NAME
  $(c Ys)git changed$(c) - Show changed files grouped by sections.

USAGE
  $(c Ys)\$ git changed $(c 0Wdi)[$(c 0Gi)OPTIONS$(c 0Wdi)] [$(c 0Mi)--$(c 0Wdi)] [$(c 0Ci)PATHSPEC...$(c 0Wdi)]$(c)

SECTIONS (CAN SPECIFY MULTIPLE)
  $(c 0G)-a$(c),  $(c 0G)--all$(c)          show all sections ( default if none specified )
  $(c 0G)-s$(c),  $(c 0G)--staged$(c)       show staged changes ( A/C/M/R )
  $(c 0G)-us$(c), $(c 0G)--unstaged$(c)     show unstaged changes ( A/C/M/R )
  $(c 0G)-ut$(c), $(c 0G)--untracked$(c)    show untracked files ( excluding ignored )
  $(c 0G)-i$(c),  $(c 0G)--ignored$(c)      show ignored files ( from .gitignore / global ignore )

  $(c 0G)--all-titles$(c)        print section titles even if empty ( default: only if has output )
  $(c 0G)--no-title$(c)          do not print section titles ( just the file names )

  $(c 0G)-h$(c), $(c 0G)--help$(c)          show this help

NOTES
  • multiple PATHSPECs are allowed; use \`$(c 0M)--$(c)\` to stop option parsing
  • deleted files are not shown by default. To include deletions, change the diff-filter from ACMR to ACMRD in the function if desired

EXAMPLES
  $(c 0Ys)\$ git changed$(c)
  $(c 0Ys)\$ git changed$(c) $(c 0Gi)--staged --untracked$(c)
  $(c 0Ys)\$ git changed$(c) $(c 0Gi)--ignored$(c) $(c 0Mi)--$(c) $(c 0Ci)src/ \"*.log\"$(c)
  $(c 0Ys)\$ git changed$(c) $(c 0Gi)--no-title$(c) $(c 0Mi)--$(c) $(c 0Ci)'*.c' '!:test/*'$(c)
"""

function usage() { echo -e "${USAGE}"; exit 0; }
function die() {
  local exitcode=1 msg; local -a args=( "$@" ); local last="${!#}";
  [[ "${last}" =~ ^[0-9]+$ ]] && { exitcode="${last}"; unset "args[$(( ${#args[@]} - 1 ))]"; }
  msg="${args[*]}"
  echo -e "$(c Ri)ERROR$(c)$(c i): ${msg}.$(c) $(c 0Wdi)exit ...$(c)" >&2; exit "${exitcode}";
}
function main()  {
  while [[ "$#" -gt 0 ]]; do
    case "$1" in
      -a  | --all       ) showStaged=1    ; showUnstaged=1; showUntracked=1; showIgnored=1; anySection=1 ;;
      -s  | --staged    ) showStaged=1    ; anySection=1                 ;;
      -us | --unstaged  ) showUnstaged=1  ; anySection=1                 ;;
      -ut | --untracked ) showUntracked=1 ; anySection=1                 ;;
      -i  | --ignored   ) showIgnored=1   ; anySection=1                 ;;
      --all-titles      ) showTitle=1                                    ;;
      --no-title        ) showTitle=2                                    ;;
      --                ) case "${2:-}" in
                            -h | --help ) usage                          ;;
                            *           ) shift; pathspec+=("$@"); set --; break ;;
                          esac                                           ;;
      -*                ) die "error: unknown option: $1" "2"            ;;
      *                 ) pathspec+=("$1")                               ;;
    esac
    shift
  done

  git rev-parse --is-inside-work-tree >/dev/null 2>&1 || {
    echo "fatal: not a git repository (or any of the parent directories): .git" >&2;
    exit 128
  }

  # default to all sections if none explicitly chosen
  if [[ "${anySection}" -eq 0 ]]; then
    showStaged=1; showUnstaged=1; showUntracked=1; showIgnored=1
  fi

  local -a ps=()
  [[ "${#pathspec[@]}" -gt 0 ]] && ps=(-- "${pathspec[@]}")

  _title() { printf "%b[%s]%b\n" "$(c 0M)" "${1}" "$(c)"; }

  # Print a section. showTitle:
  # 0: print title only if there is output
  # 1: always print title ( even if empty )
  # 2: never print title ( suppressed )
  _section() {
    local title="${1}"; shift
    local printed=0
    [[ "${showTitle}" -eq 1 ]] && { _title "${title}"; printed=1; }

    while IFS= read -r line; do
      if [[ "${showTitle}" -eq 0 && "${printed}" -eq 0 ]]; then
        _title "${title}"
        printed=1
      fi
      printf "$(c i)%s$(c)\n" "${line}"
    done < <("$@")
  }

  [[ "${showStaged}"    -eq 1 ]] && _section "STAGED"    git diff --cached --name-only --diff-filter=ACMR "${ps[@]}"
  [[ "${showUnstaged}"  -eq 1 ]] && _section "UNSTAGED"  git diff --name-only --diff-filter=ACMR "${ps[@]}"
  [[ "${showUntracked}" -eq 1 ]] && _section "UNTRACKED" git ls-files --others --exclude-standard "${ps[@]}"
  # --ignored must be used with -o or -c; here the untracked perspective is used
  [[ "${showIgnored}"   -eq 1 ]] && _section "IGNORED"   git ls-files --others --ignored --exclude-standard "${ps[@]}"

}

main "$@"

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:
