#!/usr/bin/env bash
# shellcheck source=/dev/null
#=============================================================================
#     FileName : git-changed
#       Author : marslo
#      Created : 2025-08-22 15:24:56
#   LastChange : 2025-12-04 02:29:14
#=============================================================================

set -euo pipefail

# credit: https://github.com/ppo/bash-colors
if test -f "${HOME}/.marslo/bin/bash-color.sh"; then
  source "${HOME}/.marslo/bin/bash-color.sh"
else
  # or copy & paste the `c()` function from https://github.com/ppo/bash-colors/blob/master/bash-colors.sh#L3
  c() { :; }
fi


# section toggles (default all if none specified)
declare showStaged=0 showUnstaged=0 showUntracked=0 showIgnored=0 anySection=0
# title mode: 0=auto (only when has output), 1=all (force), 2=none (suppress)
declare showTitle=0
declare -a pathspec=()

# shellcheck disable=SC2125
declare USAGE="""
Show changed files grouped by sections.

USAGE:
  \$ git changed [OPTIONS] [--] [PATHSPEC...]

SECTIONS (CAN SPECIFY MULTIPLE)
  -s,  --staged       show staged changes ( A/C/M/R )
  -us, --unstaged     show unstaged changes ( A/C/M/R )
  -ut, --untracked    show untracked files ( excluding ignored )
  -i,  --ignored      show ignored files ( from .gitignore / global ignore )
  -a,  --all          show all sections ( default if none specified )

TITLE DISPLAY
  --all-titles   print section titles even if empty ( default: only if has output )
  --no-title     do not print section titles ( just the file names )

OTHER
  -h, --help     show this help

NOTES
  • You may pass multiple PATHSPECs; use \`--\` to stop option parsing
  • Deleted files are not shown by default. To include deletions, change the diff-filter from ACMR to ACMRD in the function if desired

EXAMPLES
  \$ git changed
  \$ git changed --staged --untracked
  \$ git changed --ignored -- src/ "*.log"
  \$ git changed --no-title -- '*.c' '!:test/*'
"""

function usage() { echo -e "${USAGE}"; exit 0; }
function die() {
  local exitcode=1 msg; local -a args=( "$@" ); local last="${!#}";
  [[ "${last}" =~ ^[0-9]+$ ]] && { exitcode="${last}"; unset "args[$(( ${#args[@]} - 1 ))]"; }
  msg="${args[*]}"
  echo -e "$(c Ri)ERROR$(c)$(c i): ${msg}.$(c) $(c 0Wdi)exit ...$(c)" >&2; exit "${exitcode}";
}
function main()  {
  if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    die "fatal: not a git repository (or any of the parent directories): .git" '128'
  fi

  while [[ "$#" -gt 0 ]]; do
    case "$1" in
      -a  | --all       ) showStaged=1    ; showUnstaged=1; showUntracked=1; showIgnored=1; anySection=1 ;;
      -s  | --staged    ) showStaged=1    ; anySection=1                 ;;
      -us | --unstaged  ) showUnstaged=1  ; anySection=1                 ;;
      -ut | --untracked ) showUntracked=1 ; anySection=1                 ;;
      -i  | --ignored   ) showIgnored=1   ; anySection=1                 ;;
      --all-titles      ) showTitle=1                                    ;;
      --no-title        ) showTitle=2                                    ;;
      --                ) case "${2:-}" in
                            -h | --help ) usage                          ;;
                            *           ) shift; pathspec+=("$@"); set --; break ;;
                          esac                                           ;;
      -*                ) die "error: unknown option: $1" "2"            ;;
      *                 ) pathspec+=("$1")                               ;;
    esac
    shift
  done

  # default to all sections if none explicitly chosen
  if [[ "${anySection}" -eq 0 ]]; then
    showStaged=1; showUnstaged=1; showUntracked=1; showIgnored=1
  fi

  local -a ps=()
  [[ "${#pathspec[@]}" -gt 0 ]] && ps=(-- "${pathspec[@]}")

  _title() { printf "%b[%s]%b\n" "$(c 0M)" "${1}" "$(c)"; }

  # Print a section. showTitle:
  # 0: print title only if there is output
  # 1: always print title ( even if empty )
  # 2: never print title ( suppressed )
  _section() {
    local title="${1}"; shift
    local printed=0
    [[ "${showTitle}" -eq 1 ]] && { _title "${title}"; printed=1; }

    while IFS= read -r line; do
      if [[ "${showTitle}" -eq 0 && "${printed}" -eq 0 ]]; then
        _title "${title}"
        printed=1
      fi
      printf "$(c i)%s$(c)\n" "${line}"
    done < <("$@")
  }

  [[ "${showStaged}"    -eq 1 ]] && _section "STAGED"    git diff --cached --name-only --diff-filter=ACMR "${ps[@]}"
  [[ "${showUnstaged}"  -eq 1 ]] && _section "UNSTAGED"  git diff --name-only --diff-filter=ACMR "${ps[@]}"
  [[ "${showUntracked}" -eq 1 ]] && _section "UNTRACKED" git ls-files --others --exclude-standard "${ps[@]}"
  # --ignored must be used with -o or -c; here the untracked perspective is used
  [[ "${showIgnored}"   -eq 1 ]] && _section "IGNORED"   git ls-files --others --ignored --exclude-standard "${ps[@]}"

}

main "$@"

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:
