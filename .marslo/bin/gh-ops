#!/usr/bin/env bash
# shellcheck source=/dev/null disable=SC2155
#=============================================================================
#     FileName : gh-ops
#       Author : marslo
#      Created : 2026-01-21 20:38:07
#   LastChange : 2026-01-24 00:36:49
#  Inspired by : https://seb.jambor.dev/posts/improving-shell-workflows-with-fzf/
#=============================================================================

set -euo pipefail

declare -r CURRENT_DIR="$( dirname "${BASH_SOURCE[0]:-$0}" )"
declare -r ME="$( basename "${BASH_SOURCE[0]:-$0}" )"
declare -r PREVIEW_BIN="${CURRENT_DIR}/gh.d/gh-ops-preview"

# @credit: https://github.com/ppo/bash-colors
# @usage:  or copy & paste the `c()` function from:
#          https://github.com/ppo/bash-colors/blob/master/bash-colors.sh#L3
if [[ -f "${CURRENT_DIR}/bash-color.sh" ]]; then
  source "${CURRENT_DIR}/bash-color.sh"
else
  c() { :; }
fi

declare -r USAGE="""
NAME
  $(c Cs)${ME}$(c) - interactively GitHub PR using fzf

USAGE
  $(c Ys)\$ ${ME}$(c) $(c Wdi)[$(c)$(c Gis)OPTIONS$(c)$(c Wdi)]$(c)

OPTIONS
  $(c G)-c$(c), $(c G)--checkout$(c)       checkout the selected pull request ( $(c Cis)*default$(c) )
  $(c G)-C$(c), $(c G)--close$(c)          close the selected pull request
  $(c G)-o$(c), $(c G)--open$(c)           open the selected pull request in the web browser
  $(c G)-m$(c), $(c G)--merge$(c)          merge the selected pull request with squash
  $(c G)-V$(c), $(c G)--verbose$(c)        show verbose output
  $(c G)--dryrun$(c)             show the command to be executed, but do not run it
  $(c G)-h$(c), $(c G)--help$(c)           show this help message
  $(c C)--$(c) $(c 0Wdi)[$(c 0Mi)GH_OPTIONS$(c 0Wdi)]$(c)      pass all following arguments to the underlying '$(c 0i)gh pr checkout/close$(c)' command

EXAMPLES
  $(c Wdi)# interactively select a pull request and checkout the corresponding branch$(c)
  $(c 0Ys)\$ ${ME} $(c 0Wdi)or $(c 0Ys)\$ ${ME} $(c 0Gi)--checkout$(c)

  $(c Wdi)# update all submodules after checkout$(c)
  $(c Ys)\$ ${ME} $(c 0Gi)--checkout $(c 0Ci)-- $(c 0Mi)--recurse-submodules$(c)

  $(c Wdi)# close the PR and delete the branch$(c)
  $(c Ys)\$ ${ME} $(c 0Gi)--close $(c 0Ci)-- $(c 0Mi)--delete-branch$(c)

TIPS
  while in the fzf selection menu:
    • press $(c 0Bsi)ctrl-y$(c) to copy the PR ID to clipboard
    • press $(c 0Bsi)ctrl-o$(c) to open the selected PR in the web browser
    • press $(c 0Bsi)ctrl-/$(c) to toggle between local and remote preview (requires the preview script to be present)
"""

declare OPTION='checkout'
declare DRYRUN=false
declare VERBOSE=false
declare -a GH_OPTS=()
declare SHOULD_OPEN=false

function showHelp() { echo -e "${USAGE}"; exit 0; }
function show() {
  local tag tcolor body
  local extra=''
  local bcolor="$(c 0Wi)"

  case "$1" in
    info             ) tag="$1";    shift; body="${*}"; tcolor="$(c 0Gi)"                      ;;
    warning          ) tag="$1";    shift; body="${*}"; tcolor="$(c 0Yi)"                      ;;
    error            ) tag="$1";    shift; body="${*}"; tcolor="$(c 0Ri)"                      ;;
    dryrun | verbose ) tag=">> $1"; shift; body="${*}"; tcolor="$(c 0Wdi)"; bcolor="${tcolor}" ;;
    *                ) tag='error';        body="${*}"; tcolor="$(c 0Ri)"                      ;;
  esac

  [[ 'error' == "${tag}" ]] && extra="$(c Wdi). exit ...$(c)" || extra=''
  printf "%b%s$(c)%b: %b$(c)%b\n" "${tcolor}" "${tag^^}" "${bcolor}" "${body}" "${extra}" >&2;
  [[ 'error' == "${tag}" ]] && exit 1 || :
}

function joinBy {
  local d=${1-} f=${2-}
  if shift 2; then printf %s "$f" "${@/#/$d}"; fi
}

function checkTools() {
  local -a tools=( 'gh' 'fzf' )
  local -a missing=()

  for tool in "${tools[@]}"; do
    type -P "${tool}" >/dev/null 2>&1 || missing+=( "${tool}" )
  done

  if [[ ${#missing[@]} -gt 0 ]]; then
    show error "missing required tools: $(c 0Mi)$(joinBy ', ' "${missing[@]}")$(c)"
  fi
}

function openPR() {
  local prId="${1:-}"

  if "${SHOULD_OPEN}"; then
    # shellcheck disable=SC2015
    test -n "${prId:-}" && {
      local -a openCmd=( gh pr view "${prId}" --web )
      "${VERBOSE}" && show info "opening PR $(c 0Mi)\`#${prId}\`$(c 0Wdi) in web browser ...$(c)" || :
      "${openCmd[@]}"
    } || {
      show warning "cannot open PR: no PR ID found"
    }
  fi
}

function getId() {
  local template prId CACHE_FILE
  CACHE_FILE="/tmp/gh_ops_cache_$$"
  # shellcheck disable=SC2064
  trap "rm -f ${CACHE_FILE}" EXIT

  template='"'
  template+='#\(.number) - \(.title)'
  template+='\t'
  template+='Author: \(.user.login)\n'
  template+='Created: \(.created_at)\n'
  template+='Updated: \(.updated_at)\n\n'
  template+='\(.title)'
  template+='\(if .title == (.body // "") then "" else "\n\n" + (.body // "") end)'
  template+='"'

  gh api 'repos/:owner/:repo/pulls' |
    jq ".[] | ${template}" |
    sed -e 's/"\(.*\)"/\1/' -e 's/\\t/\t/' > "${CACHE_FILE}"

  export CMD_REMOTE="change-preview(sed -n \"\$(( {n} + 1 ))p\" \"${CACHE_FILE}\" | bash \"${PREVIEW_BIN}\")+change-preview-label([ REMOTE ])"
  export CMD_LOCAL="change-preview(content=\$(sed -n \"\$(( {n} + 1 ))p\" \"${CACHE_FILE}\" | cut -f2-); printf '%b\n' \"\$content\")+change-preview-label([ LOCAL ])"

  prId=$(
    cat "${CACHE_FILE}" |
    fzf --ansi \
        --with-nth=1 \
        --delimiter='\t' \
        --preview-label="[ Local ]" \
        --preview="content=\$(sed -n \"\$(( {n} + 1 ))p\" \"${CACHE_FILE}\" | cut -f2-); printf '%b\n' \"\$content\"" \
        --preview-window=top:60%:wrap \
        --bind "ctrl-y:execute-silent(echo {1} | sed -En 's/^#([0-9]+).*/\1/p' | pbcopy)" \
        --bind "ctrl-o:execute-silent(echo {1} | awk '{print \$1}' | xargs gh pr view --web)" \
        --bind "ctrl-/:transform:
          if echo \"\$FZF_PREVIEW_LABEL\" | grep -q -i \"remote\"; then
            echo \"\$CMD_LOCAL\"
          else
            if [ -f \"${PREVIEW_BIN}\" ]; then
               echo \"\$CMD_REMOTE\"
            else
               echo \"change-preview-label([ ⚠️ Script Missing ])\"
            fi
          fi" |
    sed -En 's/^#([0-9]+).*/\1/p'
  )

  unset CMD_REMOTE CMD_LOCAL
  test -n "${prId}" && echo "${prId}" || return 1
}

function main() {

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -c | --checkout ) OPTION='checkout'         ; shift     ;;
      -C | --close    ) OPTION='close'            ; shift     ;;
      -m | --merge    ) OPTION='merge'            ; shift     ;;
      -o | --open     ) SHOULD_OPEN=true          ; shift     ;;
      -V | --verbose  ) VERBOSE=true              ; shift     ;;
      --dryrun        ) DRYRUN=true               ; shift     ;;
      --              ) shift ; GH_OPTS+=( "$@" ) ; break     ;;
      -h | --help     ) showHelp                              ;;
      *               ) show error "unknown argument: \`$1\`" ;;
    esac
  done

  checkTools

  # shellcheck disable=SC2155
  local prId="$( getId )"
  local cmd=( gh pr )
  case "${OPTION}" in
    checkout | close ) cmd+=( "${OPTION}" "${prId}"          )    ;;
    merge            ) cmd+=( "${OPTION}" "${prId}" --squash )    ;;
    *                ) show error "unknown option: \`${OPTION}\`" ;;
  esac

  test -z "${prId}" && exit 0
  "${SHOULD_OPEN}"  && { openPR "${prId}"; exit 0; }

  ( "${DRYRUN}" || "${VERBOSE}" ) && {
    local msg="command to be executed: \`$(c 0Cdi)\$ ${cmd[*]}${GH_OPTS[*]:+ ${GH_OPTS[*]}}$(c 0Wdi)\` ...$(c)"
    # shellcheck disable=SC2015
    "${VERBOSE}" && show verbose "${msg}" || { show dryrun "${msg}"; exit 0; }
  }

  printf "$(c Ci)~~> %s$(c) $(c 0Mis)#%s$(c)%b $(c Ci)..$(c)\n" \
         "${OPTION}" \
         "${prId}" \
         "${GH_OPTS[*]:+ with gh OPTS $(c 0Mis)${GH_OPTS[*]}$(c)}" >&2
  "${cmd[@]}" "${GH_OPTS[@]}"
}

main "$@"

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:
