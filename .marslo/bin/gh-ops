#!/usr/bin/env bash
# shellcheck source=/dev/null disable=SC2155
#=============================================================================
#     FileName : gh-ops
#       Author : marslo
#      Created : 2026-01-21 20:38:07
#   LastChange : 2026-01-23 22:03:34
#  Inspired by : https://seb.jambor.dev/posts/improving-shell-workflows-with-fzf/
#=============================================================================

set -euo pipefail

declare -r BIN_DIR="$( dirname "${BASH_SOURCE[0]:-$0}" )"
declare -r ME="$( basename "${BASH_SOURCE[0]:-$0}" )"

# @credit: https://github.com/ppo/bash-colors
# @usage:  or copy & paste the `c()` function from:
#          https://github.com/ppo/bash-colors/blob/master/bash-colors.sh#L3
if [[ -f "${BIN_DIR}/bash-color.sh" ]]; then
  source "${BIN_DIR}/bash-color.sh"
else
  c() { :; }
fi

declare -r USAGE="""
NAME
  $(c Csi)${ME}$(c) - interactively GitHub PR using fzf

USAGE
  $(c Ys)\$ ${ME}$(c) $(c Wdi)[$(c)$(c Gis)OPTIONS$(c)$(c Wdi)]$(c)

OPTIONS
  $(c G)-c$(c), $(c G)--checkout$(c)       checkout the selected pull request ( $(c Cis)*default$(c) )
  $(c G)-C$(c), $(c G)--close$(c)          close the selected pull request
  $(c G)-o$(c), $(c G)--open$(c)           open the selected pull request in the web browser
  $(c G)-v$(c), $(c G)--verbose$(c)        show verbose output
  $(c G)--dryrun$(c)             show the command to be executed, but do not run it
  $(c G)-h$(c), $(c G)--help$(c)           show this help message
  $(c C)--$(c) $(c 0Mi)<GH_OPTS>$(c)         pass all following arguments to the underlying '$(c 0i)gh pr checkout/close$(c)' command

EXAMPLES
  $(c Wdi)# interactively select a pull request and checkout the corresponding branch$(c)
  $(c Ys)\$ ${ME} $(c 0Gi)--checkout$(c)

  $(c Wdi)# interactively select a pull request and close it$(c)
  $(c Ys)\$ ${ME} $(c 0Gi)--close$(c)

  $(c Wdi)# update all submodules after checkout$(c)
  $(c Ys)\$ ${ME} $(c 0Gi)--checkout $(c 0Ci)-- $(c 0Mi)--recurse-submodules$(c)

  $(c Wdi)# close the PR and delete the branch$(c)
  $(c Ys)\$ ${ME} $(c 0Gi)--close $(c 0Ci)-- $(c 0Mi)--delete-branch$(c)
"""

declare OPTION='checkout'
declare DRYRUN=false
declare VERBOSE=false
declare -a GH_OPTS=()
declare SHOULD_OPEN=false

function showHelp() { echo -e "${USAGE}"; exit 0; }
function show() {
  local tag tcolor body extra
  local bcolor="$(c 0Wi)"

  case "$1" in
    info             ) tag="$1";    shift; body="${*}"; tcolor="$(c 0Gi)"                      ;;
    warning          ) tag="$1";    shift; body="${*}"; tcolor="$(c 0Yi)"                      ;;
    error            ) tag="$1";    shift; body="${*}"; tcolor="$(c 0Ri)"                      ;;
    dryrun | verbose ) tag=">> $1"; shift; body="${*}"; tcolor="$(c 0Wdi)"; bcolor="${tcolor}" ;;
    *                ) tag='error';        body="${*}"; tcolor="$(c 0Ri)"                      ;;
  esac

  [[ 'error' == "${tag}" ]] && extra="$(c Wdi). exit ...$(c)" || extra=''
  printf "%b%s$(c)%b: %b$(c)%b\n" "${tcolor}" "${tag^^}" "${bcolor}" "${body}" "${extra}" >&2;
  [[ 'error' == "${tag}" ]] && exit 1 || :
}

function joinBy {
  local d=${1-} f=${2-}
  if shift 2; then printf %s "$f" "${@/#/$d}"; fi
}

function checkTools() {
  local -a tools=( 'gh' 'fzf' )
  local -a missing=()

  for tool in "${tools[@]}"; do
    type -P "${tool}" >/dev/null 2>&1 || missing+=( "${tool}" )
  done

  if [[ ${#missing[@]} -gt 0 ]]; then
    show error "missing required tools: $(c 0Mi)$(joinBy ', ' "${missing[@]}")$(c)"
  fi
}

function openPR() {
  local prId="${1:-}"

  if "${SHOULD_OPEN}"; then
    # shellcheck disable=SC2015
    test -n "${prId:-}" && {
      local -a openCmd=( gh pr view "${prId}" --web )
      "${VERBOSE}" && show info "opening PR $(c 0Mi)\`#${prId}\`$(c 0Wdi) in web browser ...$(c)" || :
      "${openCmd[@]}"
    } || {
      show warning "cannot open PR: no PR ID found"
    }
  fi
}

function getId() {
  local template prId

  template='"'
  template+='#\(.number) - \(.title)'
  template+='\t'
  template+='Author: \(.user.login)\n'
  template+='Created: \(.created_at)\n'
  template+='Updated: \(.updated_at)\n\n'
  template+='\(.title)'
  template+='\(if .title == (.body // "") then "" else "\n\n" + (.body // "") end)'
  template+='"'

  prId=$(
    gh api 'repos/:owner/:repo/pulls' |
    jq ".[] | ${template}" |
    sed -e 's/"\(.*\)"/\1/' -e 's/\\t/\t/' |
    fzf --with-nth=1 \
        --delimiter='\t' \
        --preview="printf '%b\n' {2}" \
        --preview-window=top:60%:wrap \
        --bind "ctrl-y:execute-silent(echo {1} | sed -En 's/^#([0-9]+).*/\1/p' | pbcopy)" \
        --bind "ctrl-o:execute-silent(echo {1} | awk '{print \$1}' | xargs gh pr view --web)" |
    sed -En 's/^#([0-9]+).*/\1/p'
  )

  test -n "${prId}" && echo "${prId}" || return 1
}

function main() {

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -c | --checkout ) OPTION="checkout"        ; shift      ;;
      -C | --close    ) OPTION="close"           ; shift      ;;
      -o | --open     ) SHOULD_OPEN=true         ; shift      ;;
      -v | --verbose  ) VERBOSE=true             ; shift      ;;
      --dryrun        ) DRYRUN=true              ; shift      ;;
      --              ) shift; GH_OPTS+=( "$@" ) ; break      ;;
      -h | --help     ) showHelp                              ;;
      *               ) show error "unknown argument: \`$1\`" ;;
    esac
  done

  checkTools

  # shellcheck disable=SC2155
  local prId="$( getId )"
  local cmd=( gh pr "${OPTION}" "${prId}" )

  test -z "${prId}" && exit 0
  "${SHOULD_OPEN}"  && { openPR "${prId}"; exit 0; }

  ( "${DRYRUN}" || "${VERBOSE}" ) && {

    local msg="command to be executed: \`$(c 0Cdi)\$ ${cmd[*]} ${GH_OPTS[*]}$(c 0Wdi)\` ...$(c)"
    # shellcheck disable=SC2015
    "${VERBOSE}" && show verbose "${msg}" || { show dryrun "${msg}"; exit 0; }
  }

  printf "$(c Ci)~~> %s$(c) $(c Mis)#%s$(c) $(c Ci)..$(c)\n" "${OPTION}" "${prId}" >&2
  "${cmd[@]}" "${GH_OPTS[@]}"
}

main "$@"

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:
