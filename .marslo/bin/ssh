#!/usr/bin/env bash
# shellcheck source=/dev/null
#=============================================================================
#     FileName : ssh
#       Author : marslo.jiao@gmail.com
#      Created : 2025-05-27 20:12:14
#   LastChange : 2026-02-12 23:32:49
#        Usage : /path/to/ssh -- --help
#=============================================================================

set -euo pipefail

# shellcheck disable=SC2155
declare -r HERE="$( dirname "${BASH_SOURCE[0]:-$0}" )"
# @credit: https://github.com/ppo/bash-colors
# @usage:  or copy & paste the `c()` function from:
#          https://github.com/ppo/bash-colors/blob/master/bash-colors.sh#L3
# shellcheck disable=SC2015
test -f "${HERE}/bash-colors.sh" && source "${HERE}/bash-colors.sh" || { c() { :; }; }

function showHelp() { echo -e "${USAGE}"; }
function die() { echo -e "$(c Ri)ERROR$(c) $(c Wdi): $*. exit ...$(c)" >&2; exit 1; }

# shellcheck disable=SC2155
declare -r ME="$(basename "${BASH_SOURCE[0]:-$0}" | sed 's/-/ /g')"
# shellcheck disable=SC2155
declare -r USAGE="""
SSH Wrapper with fzf Support

USAGE
  $(c Cs)\$ ${ME}                  $(c 0Mi)Launch fzf to select from SSH config (username@host)$(c)
  $(c Cs)\$ ${ME} $(c 0Wdi)[$(c 0Gi)ssh args...$(c 0Wdi)]    $(c 0Mi)Forward arguments to the native SSH command$(c)
  $(c Cs)\$ ${ME} -- $(c 0Wdi)[$(c 0Gi)wrapper options...$(c 0Wdi)]$(c)

WRAPPER OPTIONS $(c Wdi)(used only after --)$(c)
  $(c G)--help$(c), $(c G)-h$(c)           Show this help message
  $(c G)--alias$(c)              Show only Host aliases (without resolving Hostname)
  $(c G)--fzf$(c)                Force interactive host selection via fzf

DESCRIPTION
  This wrapper enhances ssh usability by integrating with fzf.
  • If no arguments are given, it launches fzf to pick a target from $(c Mi)~/.ssh/config$(c) or $(c Mi)~/.ssh/config.d/*$(c)
  • If arguments are present, they are passed to the original /usr/bin/ssh
  • Use $(c Yi)'--'$(c) to separate wrapper options from ssh options

EXAMPLES
  $(c Ys)\$ ${ME}$(c)
    $(c Wdi)↪ Shows interactive fzf selector using Host/User from SSH config$(c)

  $(c Ys)\$ ${ME} $(c 0Mi)user@example.com$(c)
    $(c Wdi)↪ Works exactly like regular SSH$(c)

  $(c Ys)\$ ${ME} $(c 0Gi)-- --help$(c)
    $(c Wdi)↪ Shows this help message$(c)

  $(c Ys)\$ ${ME} $(c 0Gi)-- --alias$(c)
    $(c Wdi)↪ Shows alias list (without resolving Hostname)$(c)
"""

declare USE_FZF=false
declare ONLY_ALIAS=false
declare -a SSH_CONFIG_FILES=()
[[ -f "$HOME/.ssh/config"   ]] && SSH_CONFIG_FILES+=("$HOME"/.ssh/config)
[[ -d "$HOME/.ssh/config.d" ]] && SSH_CONFIG_FILES+=("$HOME"/.ssh/config.d/*)

[[ "${#SSH_CONFIG_FILES[@]}" -eq 0 ]] && die "no ssh config files found ..."

declare -a wArgs=()         # wrapper args
declare -a args=()         # ssh args

for arg in "$@"; do
  case "${arg}" in
    --          ) shift; wArgs=("$@" ) ; break ;;  # everything after -- is wrapper args
    --fzf       ) USE_FZF=true       ;;
    --alias     ) ONLY_ALIAS=true    ;;
    -h | --help ) if [[ "$#" -eq 1 || "$1" == "$arg" ]]; then
                    exec /usr/bin/ssh --help
                  fi
                  args+=("$arg") ;;
    *           ) args+=("$arg") ;;
  esac
done

# handle wrapper-only commands like ssh -- --help
for warg in "${wArgs[@]}"; do
  case "${warg}" in
    -h | --help ) showHelp; exit 0 ;;
    --fzf       ) USE_FZF=true       ;;
    --alias     ) ONLY_ALIAS=true    ;;
  esac
done

if [[ "${USE_FZF}" != 'true' ]] && [[ "${#args[@]}" -gt 0 ]]; then
  exec /usr/bin/ssh "${args[@]}"
fi

hosts_list=$(awk '
    BEGIN {
      colorStart = "\033[37;2;3m"
      colorEnd   = "\033[0m"
    }
    # -------- helpers --------
    function trimDomain(s) { sub(/\.marvell\.com$/, "", s); return s }
    function isIPV4(s) { return (s ~ /^(25[0-5]|2[0-4][0-9]|1?[0-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1?[0-9]?[0-9])){3}$/) }
    function emit( i, key ) {
      if (n_alias > 0 && ip != "" && user != "") {
        for ( i = 1; i <= n_alias; i++ ) {
          key = user "@" ip " : " alias[i]
          if ( !(key in printed) ) {
            # printf "%s%s%s : %s@%s\n", colorStart, alias[i], colorEnd, user, ip
            printf "%s@%s : %s\n", user, ip, alias[i]
            printed[key] = 1
          }
        }
      }
      n_alias = 0
      delete alias
      delete seenAlias
      ip = user = ""
    }
    # -------- main --------
    /^[[:space:]]*#/ || NF == 0 { next }

    $1 == "Host" {
      emit()
      for ( i = 2; i <= NF; i++ ) {
        if ( $i ~ /^#/ ) break
        a = trimDomain($i)
        if ( isIPV4(a) ) continue
        if ( !(a in seenAlias) ) {
          alias[++n_alias] = a
          seenAlias[a] = 1
        }
      }
      next
    }
    $1 == "User"     { user = $2; next }
    $1 == "Hostname" { ip = $2; next }
    END { emit() }
  ' "${SSH_CONFIG_FILES[@]}"
)

# shellcheck disable=SC2016
target=$(
  echo "${hosts_list}" |
  awk -F':' '
    $2 !~ /sfw.*jenkins/ && $1 !~ /sms.*jenkins/ {
      printf "%s:%s\n", $2, $1
    }
  ' |
  sort |
  column -t -s ':' -o ': ' |
  fzf \
  --ansi \
  --no-multi \
  --prompt='󱚥 ' \
  --color=fg+:#979736,hl+:#979736 \
  --preview-window=right:60% \
  --delimiter='[[:space:]]+:[[:space:]]+' \
  --with-nth="$([[ "${ONLY_ALIAS}" == true ]] && echo 2 || echo 1,2)" \
  --preview '
    bash -ceu "
      user_ip=\$(cut -d : -f2 <<< \"\$1\" | xargs)
      ip=\${user_ip#*@}
      user=\${user_ip%@*}
      echo -e \"\033[36m[HOST]\033[0m \033[3;35m\$user@\$ip\033[0m\n\"
      out=\$(/sbin/ping -c1 -o -W1 \"\$ip\" 2>&1)
      [ \$? -eq 0 ] && echo \"\$out\" || echo -e \"\033[31mUnreachable or DNS error\033[0m\"
    " _ {}
  '
)

[[ -z "${target}" ]] && die 'no target selected ...'

IFS=':' read -ra parts <<< "${target}"
sshTarget="${parts[0]//[[:space:]]/}"
exec /usr/bin/ssh "${sshTarget}"

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:
