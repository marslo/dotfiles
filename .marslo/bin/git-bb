#!/usr/bin/env bash
#=============================================================================
#     FileName : git-bb
#       Author : marslo.jiao@gmail.com
#      Created : 2023-12-11 21:39:58
#   LastChange : 2026-01-26 17:19:45
#  Description : git branch switcher
#                 - init : [a83a0ec](https://github.com/marslo/dotfiles/commit/a83a0ec625f154dc096750b777cb39108e50e5f9)
#                 - latest : add `ctrl-/`, `enter` and `ctrl-y` to modify view and copy commit hash
#                 -  - E0A0/E725
#=============================================================================

set -euo pipefail

# isGHE && main="$(gh repo view --json defaultBranchRef -q .defaultBranchRef.name)"
function isGHE() {
  git remote get-url origin | grep -qE '(git@|https://).+[:/]Marvell-[^/]+/'
}

function getBranch() {
  # shellcheck disable=SC2155
  local current="$(git branch --show-current)"
  local gpreview="git show --color=always {-1}"
  # git remote set-head origin --auto
  test -f "$(git rev-parse --absolute-git-dir)"/refs/remotes/origin/HEAD &&
    main="$(git symbolic-ref --short refs/remotes/origin/HEAD | sed 's|^origin/||')" ||
    main=''

  # shellcheck disable=SC2155
  local branch=$({
                   echo "${main}";
                   git for-each-ref refs/heads refs/remotes --sort=-committerdate --format="%(refname:short)";
                 } |
                 grep -v --color=never -E "^(${current}|origin/${current})$" |
                 # awk 'NF && !seen[$0]++' |
                 awk -v cur="${current}" -v remote=$'\033[0;3m' -v local=$'\033[0;32m' -v reset=$'\033[0m' '
                   NF  { a[++n] = $0; if ( $0 !~ /^origin\// ) L[$0] = 1; }
                   END {
                         for (i = 1; i <= n; i++) {
                           x = a[i]
                           if ( S[x]++ || x == "origin" || x == cur ) continue
                           if ( x ~ /^origin\// ) { if ( L[substr(x, 8)] ) continue; print remote x reset }
                           else { print local x reset }
                         }
                   }' |
                fzf +m --ansi --prompt=' ' -0 \
                     --height 50% --min-height 10+ \
                     --style full --no-input-border \
                     --preview "${gpreview} -s" \
                     --preview-window=right,55%,nofollow --preview-label-pos='bottom' \
                     --bind "ctrl-o:execute(${gpreview})+change-preview(${gpreview} -s)+change-prompt( )" \
                     --bind 'ctrl-/:change-preview-window:up,60%|hidden|right,55%' \
                     --bind 'ctrl-y:execute-silent(git log {-1} -1 --pretty=format:"%H" | pbcopy)' |
                 sed -rn "s:\s*(origin/)?(.*)$:\2:p"
                )
  [[ -n "${branch}" ]] && echo "${branch}" || exit 1
}

if [[ $# -eq 1 ]]; then
  branch="$1"
else
  branch="$(getBranch)"
fi

[[ -n "${branch:-}" ]] &&
printf "\033[1;33m~~> %s\033[0m\n" "${branch}" &&
git checkout --force "${branch}"

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:
