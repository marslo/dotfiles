#!/usr/bin/env bash
# shellcheck source=/dev/null disable=SC2155
#=============================================================================
#     FileName : gh-ops-pr
#       Author : marslo
#      Created : 2026-01-21 20:38:07
#   LastChange : 2026-01-23 19:22:52
#  Inspired by : https://seb.jambor.dev/posts/improving-shell-workflows-with-fzf/
#=============================================================================

set -euo pipefail

declare -r BIN_DIR="$( dirname "${BASH_SOURCE[0]:-$0}" )"
declare -r ME="$( basename "${BASH_SOURCE[0]:-$0}" )"

# @credit: https://github.com/ppo/bash-colors
# @usage:  or copy & paste the `c()` function from:
#          https://github.com/ppo/bash-colors/blob/master/bash-colors.sh#L3
if [[ -f "${BIN_DIR}/bash-color.sh" ]]; then
  source "${BIN_DIR}/bash-color.sh"
else
  c() { :; }
fi

declare -r USAGE="""
NAME
  $(c Csi)${ME}$(c) - interactively GitHub PR using fzf

USAGE
  $(c Ys)\$ ${ME}$(c) $(c Wdi)[$(c)$(c Gis)OPTIONS$(c)$(c Wdi)]$(c)

OPTIONS
  $(c G)--co$(c), $(c G)--checkout$(c)     checkout the selected pull request ( $(c Cis)*default$(c) )
  $(c G)--cl$(c), $(c G)--close$(c)        close the selected pull request
  $(c G)-v$(c), $(c G)--verbose$(c)        show verbose output
  $(c G)--dryrun$(c)                       show the command to be executed, but do not run it
  $(c G)-h$(c), $(c G)--help$(c)           show this help message
"""
declare DRYRUN=false
declare VERBOSE=false

function showHelp() { echo -e "${USAGE}"; exit 0; }
function show() {
  local tag tcolor body extra
  local bcolor="$(c 0Wi)"

  case "$1" in
    info             ) tag="$1";    shift; body="${*}"; tcolor="$(c 0Gi)"                      ;;
    warning          ) tag="$1";    shift; body="${*}"; tcolor="$(c 0Yi)"                      ;;
    error            ) tag="$1";    shift; body="${*}"; tcolor="$(c 0Ri)"                      ;;
    dryrun | verbose ) tag=">> $1"; shift; body="${*}"; tcolor="$(c 0Wdi)"; bcolor="${tcolor}" ;;
    *                ) tag='error';        body="${*}"; tcolor="$(c 0Ri)"                      ;;
  esac

  [[ 'error' == "${tag}" ]] && extra="$(c Wdi). exit ...$(c)" || extra=''
  printf "%b%s$(c)%b: %b$(c)%b\n" "${tcolor}" "${tag^^}" "${bcolor}" "${body}" "${extra}" >&2;
  [[ 'error' == "${tag}" ]] && exit 1 || :
}

function getId() {
  local template prId

  template='"'
  template+='#\(.number) - \(.title)'
  template+='\t'
  template+='Author: \(.user.login)\n'
  template+='Created: \(.created_at)\n'
  template+='Updated: \(.updated_at)\n\n'
  template+='\(.body)'
  template+='"'

  prId=$(
    gh api 'repos/:owner/:repo/pulls' |
    jq ".[] | ${template}" |
    sed -e 's/"\(.*\)"/\1/' -e 's/\\t/\t/' |
    fzf --with-nth=1 \
        --delimiter='\t' \
        --preview="printf '%b\n' {2}" \
        --preview-window=top:wrap \
        --bind "ctrl-y:execute-silent(echo {1} | sed -En 's/^#([0-9]+).*/\1/p' | pbcopy)" \
        --bind "ctrl-o:execute-silent(echo {1} | awk '{print \$1}' | xargs gh pr view --web)" |
    sed -En 's/^#([0-9]+).*/\1/p'
  )

  [ -n "${prId}" ] && echo "${prId}" || return 1
}

function main() {

  declare OPTION='checkout'
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --co | --checkout ) OPTION="checkout" ; shift  ;;
      --cl | --close    ) OPTION="close"    ; shift  ;;
      -h | --help       ) showHelp                   ;;
      -v | --verbose    ) VERBOSE=true      ; shift  ;;
      --dryrun          ) DRYRUN=true       ; shift  ;;
      *                 ) echo "Unknown argument: $1" >&2; exit 1 ;;
    esac
  done

  # shellcheck disable=SC2155
  local prId="$(getId)"
  [ -z "${prId}" ] &&  show 'no PR selected'

  local cmd=("gh" "pr" "${OPTION}" "${prId}")

  ( "${DRYRUN}" || "${VERBOSE}" ) && {
    local msg="command to be executed: \`$(c 0Cdi)\$ ${cmd[*]}$(c 0Wdi)\` ...$(c)"
    # shellcheck disable=SC2015
    "${VERBOSE}" && show verbose "${msg}" || { show dryrun "${msg}"; exit 0; }
  }

  printf "$(c Ci)~~> %s$(c) $(c Mis)#%s$(c) $(c Ci)..$(c)\n" "${OPTION}" "${prId}" >&2
  "${cmd[@]}"
}

main "$@"

# vim:tabstop=2:softtabstop=2:shiftwidth=2:expandtab:filetype=sh:
